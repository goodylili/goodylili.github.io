<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    

    
        <title>
             Using Rust GATs to improve code and application performance
            
        </title>

        
            <meta property="og:title" content="Using Rust GATs to improve code and application performance" />
        
    

    
        
            <meta property="og:description" content="Generic associated types in Rust can help us address some of the languageâ€™s limitations and improve performance." />
        
    

    
        
            <meta name="description" content="Generic associated types in Rust can help us address some of the languageâ€™s limitations and improve performance." />
        
    

    
         <link rel="icon" type="image/png" href=&#x2F;icon&#x2F;favicon.png />
    

    

    

    
    
        <script src=//goodnessuc.github.io/js/feather.min.js></script>
    


    
        <link href=//goodnessuc.github.io/css/fonts.css rel="stylesheet" />
    

    <link rel="stylesheet" type="text/css" media="screen" href=//goodnessuc.github.io/css/main.css />

    
        <link
            rel="stylesheet"
            id="darkModeStyle"
            type="text/css"
            href=//goodnessuc.github.io/css/dark.css
            
            
                disabled
            
        />
    


    


</head>


<body>
    <div class="content">
        <header>
    <div class="main" id="main_title">
        <a href=&#x2F;&#x2F;goodnessuc.github.io>Goodnessuc</a>
    </div>

    <nav>
        
            <a href=&#x2F;>Home</a>
        
            <a href=&#x2F;posts>All posts</a>
        
            <a href=&#x2F;about>About</a>
        
            <a href=&#x2F;tags>Tags</a>
        

        
            |

            
                <a href=&#x2F;>en</a>
            
        

        
            | <a id="dark-mode-toggle" onclick="toggleTheme()" href=""></a>
            <script src=//goodnessuc.github.io/js/themetoggle.js></script>
        

    <! -- GoadCounter analytics script -->
        <script data-goatcounter="https://ghostmac.goatcounter.com/count"
                async src="//gc.zgo.at/count.js"></script>
    </nav>
</header>


        
    
<main>
    <article>
        <div class="title">
            <h1 class="title">Using Rust GATs to improve code and application performance</h1>
            <div class="meta">
                
                on  2023-08-22

                
            </div>
        </div>

        

        <section class="body">
            <hr />
<p><em><strong><a href="//goodnessuc.github.io/posts/rust-gats/logrocket.com">LogRocket</a> made this piece possible. They provide AI-first session replay and analytics that shows
you what's wrong.</strong></em></p>
<p>Generic associated types in Rust can help us address some of the languageâ€™s limitations and improve performance.</p>
<p><img src="/imgs/Rust-Generic-Associated-Types.png" alt="Rust-GATs" /></p>
<p>Before GATs, Rust had associated types that enabled type association with traits. However, these were not directly tied
to the generic parameters of the implementing type. GATs enhance this concept by allowing associated types to depend on
the generic parameters of a trait.</p>
<p>GATs are useful in several scenarios, including the expression of iterator patterns and futures
and <a href="https://blog.logrocket.com/a-practical-guide-to-async-in-rust/">asynchronous programming</a>. Here, async libraries
can leverage GATs to define traits with associated types that accurately represent these dependencies and provide more
precise type information for async operations.</p>
<p>In this article, we will explore some ways we can use GATs in Rust to improve our code and application performance.</p>
<p><em>Note that GATs became a stable Rust feature in v1.65. Since GATs were unstable before v1.65, you must
add <code>#![feature(generic_associated_types)]</code> to use GATs in earlier Rust versions.</em></p>
<h2 id="getting-started-with-rust-generic-associated-types">Getting started with Rust generic associated types</h2>
<p>Rust traits can have associated types. However, before GATS, these associated types could not have their own generic
parameters. GATs lift this
restriction, <a href="https://blog.logrocket.com/understanding-rust-generics/#advanced-generic-types-rust-generic-associated-types">allowing associated types to be generic</a>
and have a lifetime or type parameter.</p>
<p>Consider this example Rust trait with an associated type:</p>
<pre data-lang="rust" style="background-color:#fafafa;color:#383a42;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#a626a4;">trait </span><span>Producer {
</span><span>    </span><span style="color:#a626a4;">type </span><span>Item;
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">produce</span><span>(</span><span style="color:#a626a4;">&amp;</span><span style="color:#e45649;">self</span><span>) -&gt; </span><span style="color:#a626a4;">Self::</span><span>Item;
</span><span>}
</span></code></pre>
<p>The Producer trait has a <code>produce()</code> method that takes a reference to self and returns an item of type <code>Self::Item</code>.
The <code>Self::Item</code> syntax refers to the associated Item type defined within the trait.</p>
<p>With GATs, you can extend the trait to allow the associated type to have a generic parameter:</p>
<pre data-lang="rust" style="background-color:#fafafa;color:#383a42;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#a626a4;">trait </span><span>Producer {
</span><span>    </span><span style="color:#a626a4;">type </span><span>Item</span><span style="color:#a626a4;">&lt;</span><span>T</span><span style="color:#a626a4;">&gt;</span><span>;
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">produce</span><span>&lt;T&gt;(</span><span style="color:#a626a4;">&amp;</span><span style="color:#e45649;">self</span><span>, </span><span style="color:#e45649;">value</span><span>: T) -&gt; </span><span style="color:#a626a4;">Self::</span><span>Item&lt;T&gt;;
</span><span>}
</span></code></pre>
<p>In this case, the Producer trait declares the produce method that takes a value of type <code>T</code> as a parameter and returns
an
item of type <code>Self::Item&lt;T&gt;</code>. The <code>syntax Self::Item&lt;T&gt;</code> refers to the associated type <code>Item&lt;T&gt;</code> associated with the
implementing type.</p>
<p>GATs form a cornerstone in Rustâ€™s type system, offering a previously unattainable level of expressiveness. They allow
you to write more generic and reusable code, reducing boilerplate and enhancing code maintainability.</p>
<p>For instance, GATs enable you to define traits that return types with lifetimes tied to self, which previously wasnâ€™t
possible. This capability is crucial for creating iterator traits that yield references to their items, amongst other
applications.</p>
<h2 id="when-to-use-gats-in-rust">When to use GATs in Rust</h2>
<p>GATs are handy in scenarios where you need to express complex relationships between types and lifetimes in Rust. They
are especially useful when designing APIs that need to return types with lifetimes tied to self or when creating generic
data structures.</p>
<p>Consider a scenario where youâ€™re creating a data structure that holds a collection of items and provides an iterator
over the items. Without GATs, youâ€™ll have to use <code>Box&lt;dyn Iterator&gt;</code>, which incurs a runtime cost.</p>
<p>With GATs, you can express this naturally like so:</p>
<pre data-lang="rust" style="background-color:#fafafa;color:#383a42;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#a626a4;">trait </span><span>Iterable {
</span><span>    </span><span style="color:#a626a4;">type </span><span>Item;
</span><span>    </span><span style="color:#a626a4;">type </span><span>Iterator</span><span style="color:#a626a4;">&lt;&#39;a&gt;</span><span>: Iterator&lt;Item=</span><span style="color:#a626a4;">&amp;&#39;a Self::</span><span>Item&gt; </span><span style="color:#a626a4;">where Self</span><span>: </span><span style="color:#a626a4;">&#39;a</span><span>;
</span><span>
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">iter</span><span>&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;(</span><span style="color:#a626a4;">&amp;&#39;a </span><span style="color:#e45649;">self</span><span>) -&gt; </span><span style="color:#a626a4;">Self::</span><span>Iterator&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;;
</span><span>}
</span></code></pre>
<p>Here, the <code>iterable</code> trait has two associated types â€” <code>Item</code> and <code>Iterator</code>. The Item associated type represents a type
of the
iterable elements, and the Iterator generic associated type represents the Iterator type that the <code>iter</code> method returns.</p>
<h2 id="exploring-use-cases-for-gats-in-rust-programs">Exploring use cases for GATs in Rust programs</h2>
<p>There are several reasons and use cases for GATs in your everyday Rust programs, including avoiding unnecessary
allocations, enabling more efficient code generation, and improving code ergonomics. Letâ€™s explore each of these in more
detail below.</p>
<h2 id="avoiding-unnecessary-allocations">Avoiding unnecessary allocations</h2>
<p>One everyday use for GATs is avoiding unnecessary allocations. You can prevent unnecessary allocations by defining a
trait for iterators that allocates memory when necessary.</p>
<p>Hereâ€™s a trait that defines an iterator that can iterate over the elements of a collection and allocates memory for used
elements:</p>
<pre data-lang="rust" style="background-color:#fafafa;color:#383a42;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#![</span><span style="color:#e45649;">feature</span><span>(generic_associated_types)]
</span><span>
</span><span style="color:#a626a4;">trait </span><span>LendingIterator {
</span><span>    </span><span style="color:#a626a4;">type </span><span>Item</span><span style="color:#a626a4;">&lt;&#39;a&gt;</span><span>: </span><span style="color:#a626a4;">&#39;a where Self</span><span>: </span><span style="color:#a626a4;">&#39;a</span><span>;
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">next</span><span>&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;(</span><span style="color:#a626a4;">&amp;&#39;a mut </span><span style="color:#e45649;">self</span><span>) -&gt; Option&lt;</span><span style="color:#a626a4;">Self::</span><span>Item&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;&gt;;
</span><span>}
</span><span>
</span><span style="color:#a626a4;">struct </span><span>MyVec&lt;T&gt;(Vec&lt;T&gt;);
</span><span>
</span><span style="color:#a626a4;">impl</span><span>&lt;T&gt; LendingIterator </span><span style="color:#a626a4;">for </span><span>MyVec&lt;T&gt; </span><span style="color:#a626a4;">where</span><span> T: </span><span style="color:#a626a4;">&#39;static </span><span>{
</span><span>    </span><span style="color:#a626a4;">type </span><span>Item</span><span style="color:#a626a4;">&lt;&#39;a&gt; = &amp;&#39;a</span><span> T;
</span><span>
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">next</span><span>&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;(</span><span style="color:#a626a4;">&amp;&#39;a mut </span><span style="color:#e45649;">self</span><span>) -&gt; Option&lt;</span><span style="color:#a626a4;">Self::</span><span>Item&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;&gt; {
</span><span>        </span><span style="color:#a626a4;">if </span><span style="color:#e45649;">self</span><span>.</span><span style="color:#c18401;">0.</span><span style="color:#0184bc;">is_empty</span><span>() {
</span><span>            None
</span><span>        } </span><span style="color:#a626a4;">else </span><span>{
</span><span>            Some(</span><span style="color:#a626a4;">&amp;</span><span style="color:#e45649;">self</span><span>.</span><span style="color:#c18401;">0</span><span>[</span><span style="color:#c18401;">0</span><span>])
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">main</span><span>() {
</span><span>    </span><span style="color:#a626a4;">let mut</span><span> my_vec </span><span style="color:#a626a4;">=</span><span> MyVec(vec![</span><span style="color:#c18401;">1</span><span>, </span><span style="color:#c18401;">2</span><span>, </span><span style="color:#c18401;">3</span><span>, </span><span style="color:#c18401;">4</span><span>, </span><span style="color:#c18401;">5</span><span>]);
</span><span>
</span><span>    </span><span style="color:#a626a4;">while let </span><span>Some(item) </span><span style="color:#a626a4;">=</span><span> my_vec.</span><span style="color:#0184bc;">next</span><span>() {
</span><span>        println!(</span><span style="color:#50a14f;">&quot;</span><span style="color:#c18401;">{}</span><span style="color:#50a14f;">&quot;</span><span>, item);
</span><span>        my_vec.</span><span style="color:#c18401;">0.</span><span style="color:#0184bc;">remove</span><span>(</span><span style="color:#c18401;">0</span><span>);
</span><span>    }
</span><span>}
</span></code></pre>
<p>The Rust program above implements a custom iterator with GATs. The <code>LendingIterator</code> trait mimics the behavior of an
iterator.</p>
<p>The <code>type Item&lt;'a&gt;: 'a where Self: 'a;</code> line defines an associated type for the <code>LendingIterator</code> trait.</p>
<p>Meanwhile, <code>fn next&lt;'a&gt;(&amp;'a mut self) -&gt; Option&lt;Self::Item&lt;'a&gt;&gt;</code> is a signature for the next method required for types
that implement the <code>LendingIterator</code> trait.</p>
<p>The <code>MyVec</code> type implements the LendingIterator trait, and the main function creates a MyVec and prints the elements
before removing the elements from the vector.</p>
<p>Hereâ€™s the output from running the program:</p>
<p><img src="/imgs/Rust-gats-output.png" alt="Rust-gats-output" /></p>
<h2 id="enabling-more-efficient-code-generation">Enabling more efficient code generation</h2>
<p>GATs can help with more efficient code generation. You can use GATS to define a trait for generic data structures that
then generate code for data structures that your program uses. Letâ€™s explore an example to understand this concept
better.</p>
<p>Hereâ€™s a trait that defines a generic data structure for representing a tree:</p>
<pre data-lang="rust" style="background-color:#fafafa;color:#383a42;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#a626a4;">trait </span><span>Tree {
</span><span>    </span><span style="color:#a626a4;">type </span><span>Item</span><span style="color:#a626a4;">&lt;&#39;a&gt;</span><span>: </span><span style="color:#a626a4;">&#39;a where Self</span><span>: </span><span style="color:#a626a4;">&#39;a</span><span>;
</span><span>    </span><span style="color:#a626a4;">type </span><span>Left</span><span style="color:#a626a4;">&lt;&#39;a&gt;</span><span>: </span><span style="color:#a626a4;">&#39;a where Self</span><span>: </span><span style="color:#a626a4;">&#39;a</span><span>;
</span><span>    </span><span style="color:#a626a4;">type </span><span>Right</span><span style="color:#a626a4;">&lt;&#39;a&gt;</span><span>: </span><span style="color:#a626a4;">&#39;a where Self</span><span>: </span><span style="color:#a626a4;">&#39;a</span><span>;
</span><span>
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">root</span><span>(</span><span style="color:#a626a4;">&amp;</span><span style="color:#e45649;">self</span><span>) -&gt; </span><span style="color:#a626a4;">&amp;Self::</span><span>Item&lt;&#39;</span><span style="color:#a626a4;">_</span><span>&gt;;
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">left</span><span>(</span><span style="color:#a626a4;">&amp;</span><span style="color:#e45649;">self</span><span>) -&gt; Option&lt;</span><span style="color:#a626a4;">&amp;Self::</span><span>Left&lt;&#39;</span><span style="color:#a626a4;">_</span><span>&gt;&gt;;
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">right</span><span>(</span><span style="color:#a626a4;">&amp;</span><span style="color:#e45649;">self</span><span>) -&gt; Option&lt;</span><span style="color:#a626a4;">&amp;Self::</span><span>Right&lt;&#39;</span><span style="color:#a626a4;">_</span><span>&gt;&gt;;
</span><span>}
</span></code></pre>
<p>The <code>Tree</code> trait represents the type of elements in the tree. The <code>root()</code> method returns a reference to the treeâ€™s
root.
The <code>left()</code> and <code>right()</code> methods return references to the left and right subtrees of the tree, respectively.</p>
<p>The <code>Tree</code> trait doesnâ€™t generate any code. Instead, it leaves the task to the types that implement the trait to decide
the methods to implement depending on the specific tree type being represented.</p>
<p>By using generic associated types, the Tree trait allows for flexibility in defining the types of items and left and
right subtrees within a tree data structure. The implementing types of the Tree trait will determine the specific types
for <code>Item</code>, <code>Left</code>, and <code>Right</code>.</p>
<p>This approach can help you generate more efficient code for various tree data structures.</p>
<h2 id="improving-the-ergonomics-of-your-code">Improving the ergonomics of your code</h2>
<p>You can use GATs to improve your code ergonomics in multiple ways. You can define a trait for generic builders that
eases the creation of complex data structures.</p>
<p>Hereâ€™s a trait that defines a generic builder for creating trees:</p>
<pre data-lang="rust" style="background-color:#fafafa;color:#383a42;" class="language-rust "><code class="language-rust" data-lang="rust"><span>
</span><span style="color:#a626a4;">trait </span><span>TreeBuilder&lt;T&gt; {
</span><span style="color:#a626a4;">type </span><span>Tree</span><span style="color:#a626a4;">&lt;&#39;a&gt;</span><span>;
</span><span>
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">root</span><span>&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;(</span><span style="color:#e45649;">self</span><span>, </span><span style="color:#e45649;">value</span><span>: T) -&gt; </span><span style="color:#a626a4;">Self::</span><span>Tree&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;;
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">left</span><span>&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;(</span><span style="color:#e45649;">self</span><span>, </span><span style="color:#e45649;">value</span><span>: T) -&gt; </span><span style="color:#a626a4;">Self::</span><span>Tree&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;;
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">right</span><span>&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;(</span><span style="color:#e45649;">self</span><span>, </span><span style="color:#e45649;">value</span><span>: T) -&gt; </span><span style="color:#a626a4;">Self::</span><span>Tree&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;;
</span><span>    </span><span style="color:#a626a4;">fn </span><span style="color:#0184bc;">build</span><span>&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;(</span><span style="color:#e45649;">self</span><span>) -&gt; </span><span style="color:#a626a4;">Self::</span><span>Tree&lt;</span><span style="color:#a626a4;">&#39;a</span><span>&gt;;
</span><span>
</span><span>}
</span></code></pre>
<p>You can use the <code>TreeBuilder</code> trait to create complex trees easily. The trait provides methods for creating trees with one
root value, along with a <code>left</code> and <code>right</code> subtree. The <code>build</code> method returns a reference to the tree.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, we discussed generic associated types (GATs) in Rust. We explored some of their use cases and how you
can use them to improve the overall performance of your Rust applications.</p>
<p>GATs provide a more expressive and powerful way to model relationships between generic and associated types in Rust.
They enable more precise type information and help you implement advanced patterns and libraries in areas such as
iterator design, asynchronous programming, and type-level computations.</p>

        </section>

        
            <div class="post-tags">
                <nav class="nav tags">
                    <ul class="tags">
                        
                            <li><a href=//goodnessuc.github.io/tags/rust/>Rust</a></li>
                        
                            <li><a href=//goodnessuc.github.io/tags/generics/>Generics</a></li>
                        
                            <li><a href=//goodnessuc.github.io/tags/improvements/>Improvements</a></li>
                        
                            <li><a href=//goodnessuc.github.io/tags/technical/>Technical</a></li>
                        
                    </ul>
                </nav>
            </div>
        

    </article>
</main>



        <footer>
    <div style="display:flex">
        
        <a class="soc" href=https:&#x2F;&#x2F;github.com&#x2F;goodnessuc&#x2F; title=GitHub>
            <i data-feather=github></i>
        </a>
        
        <a class="soc" href=https:&#x2F;&#x2F;x.com&#x2F;goodylili title=Twitter>
            <i data-feather=twitter></i>
        </a>
        
        <a class="soc" href=mailto:ukejegoodness599@gmail.com title=mail>
            <i data-feather=mail></i>
        </a>
        
        <a class="soc" href=https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;goodnessuc&#x2F; title=LinkedIn>
            <i data-feather=LinkedIn></i>
        </a>
        
    </div>
    <div class="footer-info">
        2024 Â© goodnessuc ðŸ˜‡ |
        <a href="https://docs.google.com/document/d/1eRrR-blUADxdC7brWlGTye8yd_NQDl2Eac8TB1l5N1o/edit?usp=sharing">My CV</a>
    </div>
</footer>


<script>
    feather.replace();
</script>

    </div>
</body>

</html>
